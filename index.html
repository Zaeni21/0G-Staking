<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stake JWR</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <div class="max-w-md mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Stake JWR</h1>

    <div class="bg-white shadow rounded-lg p-4 mb-6">
      <div class="flex justify-between items-center text-sm">
        <div>
          <p class="text-gray-500">Wallet</p>
          <p id="walletAddress" class="font-mono">-</p>
        </div>
        <div class="space-x-2">
          <span id="walletStatus">
            <span id="connectBtn" class="text-blue-600 font-medium cursor-pointer" onclick="connectWallet()">Connect</span>
            <span id="disconnectBtn" class="text-red-600 font-medium cursor-pointer hidden" onclick="disconnectWallet()">Disconnect</span>
          </span>
        </div>
      </div>
      <p id="walletBalance" class="text-sm text-gray-500 mt-1">Balance: -</p>
      <div class="text-center text-sm text-gray-500 mb-2">
        APY: <span id="apyValue">-</span>% &bull; Pool: <span id="poolBalance">-</span> JWR
      </div>
      <div class="grid grid-cols-2 gap-4 text-center mt-4">
        <div>
          <p class="text-gray-500">Total Staked</p>
          <p id="totalStaked" class="text-lg font-semibold">-</p>
        </div>
        <div>
          <p class="text-gray-500">Pending Rewards</p>
          <p id="pendingRewards" class="text-lg font-semibold">0.00 JWR</p>
        </div>
      </div>
    </div>

    <div id="stakeForm" class="bg-white shadow rounded-lg p-4">
      <label class="block text-sm text-gray-500 mb-1" for="amount">Amount</label>
      <input type="number" id="amount" placeholder="0.0" class="w-full p-2 border rounded mb-3" />
      <input type="range" min="0" max="100" value="0" id="slider" class="w-full mb-1">
      <p id="percentageText" class="text-sm text-right text-gray-500 mb-3">0%</p>

      <div class="grid grid-cols-2 gap-4 mb-3">
        <button id="stakeBtn" onclick="setMode('stake')" class="bg-gray-900 text-white py-2 rounded">Stake</button>
        <button id="unstakeBtn" onclick="setMode('unstake')" class="bg-gray-200 text-gray-800 py-2 rounded">Unstake</button>
      </div>
      <button onclick="confirmAction()" class="w-full bg-blue-600 text-white py-2 rounded">Confirm</button>
      <!-- Tombol yang bisa dilipat -->
      <div id="actionButtons" class="grid grid-cols-2 gap-4 mt-4 transition-all duration-300 origin-top">
        <button onclick="claimRewards()" class="bg-gray-200 text-gray-800 text-sm py-1.5 rounded">Claim</button>
        <button onclick="depositRewards()" class="bg-gray-200 text-gray-800 text-sm py-1.5 rounded">Deposit</button>
      </div>
      <!-- Tombol Toggle -->
      <div class="text-center mt-2">
        <button onclick="toggleActions()" class="text-sm text-gray-500 hover:text-black">
          Toggle Actions
        </button>
      </div>
    </div>

    <p class="text-center text-xs text-gray-400 mt-6">Built by JAWIRNFT with love for degen culture</p>
  </div>

  <!-- Floating Faucet Button -->
  <button onclick="getFaucet()" class="fixed bottom-5 right-5 bg-blue-600 text-white text-xs px-3 py-2 rounded shadow-lg hover:bg-blue-700 z-50">
    Faucet JWR
  </button>

  <div id="txHashMsg" class="fixed bottom-16 right-4 bg-white shadow-md text-blue-600 text-xs px-3 py-2 rounded hidden z-50">
    <a id="txLink" href="#" target="_blank">View Transaction</a>
  </div>

<script>
let provider, signer, walletAddress, multiContract, tokenContract;
let balance = 0, totalStaked = 0, mode = "stake";

const multiStakingAddress = "0x3E28B27B8faA9BfffbAE49A19fcdBe43e3D3cd39"; // Contract staking JWR
const multiStakingAbi = [
  "function stake(address token, uint256 amount) public",
  "function unstake(address token, uint256 amount) public",
  "function claimReward(address token) public",
  "function pendingReward(address token, address user) public view returns (uint256)",
  "function depositReward(address token, uint256 amount) external"
];
const erc20Address = "0x4e54b5aeb805d826a6c1ad8abc9cbf05e49457c3";
const erc20Abi = [
  "function faucet() public",
  "function approve(address spender, uint256 amount) public returns (bool)",
  "function allowance(address owner, address spender) public view returns (uint256)",
  "function balanceOf(address owner) public view returns (uint256)"
];

async function connectWallet() {
  if (!window.ethereum) return alert("Please install MetaMask or OKX Wallet");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  // ADD CHAIN jika belum ada
  await provider.send("wallet_addEthereumChain", [{
    chainId: '0x40d9',
    chainName: '0G-Galileo-Testnet',
    rpcUrls: ['https://evmrpc-testnet.0g.ai'],
    nativeCurrency: { name: 'OG Token', symbol: 'OG', decimals: 18 },
    blockExplorerUrls: ['https://chainscan-galileo.0g.ai/']
  }]);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  walletAddress = await signer.getAddress();
  multiContract = new ethers.Contract(multiStakingAddress, multiStakingAbi, signer);
  tokenContract = new ethers.Contract(erc20Address, erc20Abi, signer);

  document.getElementById("walletAddress").textContent = walletAddress.slice(0, 6) + "..." + walletAddress.slice(-4);
  document.getElementById("connectBtn").classList.add("hidden");
  document.getElementById("disconnectBtn").classList.remove("hidden");
  updateUI();
}

function disconnectWallet() {
  provider = null;
  signer = null;
  walletAddress = null;
  document.getElementById("walletAddress").textContent = "-";
  document.getElementById("walletBalance").textContent = "Balance: -";
  document.getElementById("connectBtn").classList.remove("hidden");
  document.getElementById("disconnectBtn").classList.add("hidden");
}

function setMode(selected) {
  mode = selected;
  document.getElementById('stakeBtn').className = selected === 'stake' ? "bg-gray-900 text-white py-2 rounded" : "bg-gray-200 text-gray-800 py-2 rounded";
  document.getElementById('unstakeBtn').className = selected === 'unstake' ? "bg-gray-900 text-white py-2 rounded" : "bg-gray-200 text-gray-800 py-2 rounded";
}

async function confirmAction() {
  const amount = parseFloat(document.getElementById("amount").value);
  if (!walletAddress) return alert("Connect wallet.");
  if (!amount || amount <= 0) return alert("Enter valid amount.");
  const value = ethers.utils.parseEther(amount.toString());

  const allowance = await tokenContract.allowance(walletAddress, multiStakingAddress);
  if (allowance.lt(value)) {
    const approveTx = await tokenContract.approve(multiStakingAddress, value);
    await approveTx.wait();
  }

  const tx = mode === "stake"
    ? await multiContract.stake(erc20Address, value)
    : await multiContract.unstake(erc20Address, value);

  const receipt = await tx.wait();
  const txBox = document.getElementById("txHashMsg");
  const txLink = document.getElementById("txLink");
  txLink.href = `https://chainscan-galileo.0g.ai/tx/${receipt.transactionHash}`;
  txBox.classList.remove("hidden");
  setTimeout(() => { txBox.classList.add("hidden"); }, 10000);
  updateUI();
}

async function claimRewards() {
  const tx = await multiContract.claimReward(erc20Address);
  const receipt = await tx.wait();
  const txBox = document.getElementById("txHashMsg");
  const txLink = document.getElementById("txLink");
  txLink.href = `https://chainscan-galileo.0g.ai/tx/${receipt.transactionHash}`;
  txBox.classList.remove("hidden");
  setTimeout(() => { txBox.classList.add("hidden"); }, 10000);
  updateUI();
}

async function getFaucet() {
  if (!walletAddress) return alert("Connect wallet first.");
  const tx = await tokenContract.faucet();
  const receipt = await tx.wait();
  const txBox = document.getElementById("txHashMsg");
  const txLink = document.getElementById("txLink");
  txLink.href = `https://chainscan-galileo.0g.ai/tx/${receipt.transactionHash}`;
  txBox.classList.remove("hidden");
  setTimeout(() => { txBox.classList.add("hidden"); }, 10000);
  updateUI();
}

async function updateUI() {
  if (!walletAddress) return;
  const tokenBal = await tokenContract.balanceOf(walletAddress);
  const reward = await multiContract.pendingReward(erc20Address, walletAddress);
  const poolBal = await tokenContract.balanceOf(multiStakingAddress);
  balance = parseFloat(ethers.utils.formatEther(tokenBal));
  document.getElementById("walletBalance").textContent = `Balance: ${balance.toFixed(2)} JWR`;
  document.getElementById("pendingRewards").textContent = parseFloat(ethers.utils.formatEther(reward)).toFixed(2) + " JWR";
  document.getElementById("totalStaked").textContent = "-";
  document.getElementById("apyValue").textContent = "20";
  document.getElementById("poolBalance").textContent = parseFloat(ethers.utils.formatEther(poolBal)).toFixed(2);
}

// Toggle untuk action panel
let actionsVisible = true;
function toggleActions() {
  const box = document.getElementById("actionButtons");
  if (actionsVisible) {
    box.style.transform = "scaleY(0)";
    box.style.height = "0";
    box.style.opacity = "0";
    box.style.overflow = "hidden";
  } else {
    box.style.transform = "scaleY(1)";
    box.style.height = "auto";
    box.style.opacity = "1";
    box.style.overflow = "visible";
  }
  actionsVisible = !actionsVisible;
}

// Slider + input sinkron
window.onload = () => {
  document.getElementById("connectBtn").addEventListener("click", connectWallet);
  const slider = document.getElementById("slider");
  const amountInput = document.getElementById("amount");
  const percentageText = document.getElementById("percentageText");
  slider.addEventListener("input", () => {
    const base = mode === "stake" ? balance : totalStaked;
    const val = (parseFloat(slider.value) / 100) * base;
    amountInput.value = val.toFixed(2);
    percentageText.textContent = `${slider.value}%`;
  });
  amountInput.addEventListener("input", () => {
    const base = mode === "stake" ? balance : totalStaked;
    const val = Math.min(base, parseFloat(amountInput.value) || 0);
    slider.value = ((val / base) * 100).toFixed(0);
    percentageText.textContent = `${slider.value}%`;
  });
};

// Auto update reward tiap 3 detik
setInterval(async () => {
  if (walletAddress && multiContract) {
    try {
      const reward = await multiContract.pendingReward(erc20Address, walletAddress);
      document.getElementById("pendingRewards").textContent = parseFloat(ethers.utils.formatEther(reward)).toFixed(4) + " JWR";
    } catch (err) {
      console.error("Failed to update reward:", err);
    }
  }
}, 3000);

</script>
</body>
</html>
